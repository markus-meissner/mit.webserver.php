#!/bin/bash
#
# Managed by ansible (mit.webserver.php)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
#
# Sets correct file permissions for shared web projects.
#
# Create /etc/update-facls.conf with dir, user and group, e.g.:
# /srv/www/monheim.de/www-dev/htdocs     www-dev        monheim
#
# v2018-04-13-1, markus.meissner@meissner.IT

# exit on error (equals set -o errexit)
set -e
# exit if variable is unset
set -u

# No config file no work to do
[ -f /etc/update-facls.conf ] || exit 0

while read -r line; do
    IFS=' ' read -r -a array <<< "$line"
    DIR=${array[0]}
    OWNER=${array[1]}
    GROUP=${array[2]}

    cd ${DIR}
    chown -R ${OWNER}:${GROUP} ${DIR}
    chmod -R o-w ${DIR}

    find ${DIR} -type f -exec setfacl -m g:${GROUP}:rw {} \;
    find ${DIR} -type d \
            -exec chmod g+rwx {} \; \
            -exec setfacl -m g:${GROUP}:rwx {} \; \
            -exec setfacl -d -m g:${GROUP}:rwx {} \;

done < /etc/update-facls.conf

