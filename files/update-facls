#!/bin/bash
#
# Managed by ansible (mit.webserver.php)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
#
# Sets correct file permissions for shared web projects.
#
# Create /etc/update-facls.conf with dir, user and group, e.g.:
# /srv/www/monheim.de/www-dev/htdocs www-dev monheim
#
# Calling without parameters processes all configured directories.
# Calling with parameter "dir" processes only the specified directories (which
# still must be set in /etc/update-facls.conf).
#
# v2023-09-13-1, markus.meissner@meissner.IT

# exit on error (equals set -o errexit)
set -e

# No config file no work to do
[ -f /etc/update-facls.conf ] || exit 0

function updateFacls {
    # exit if variable is unset
    set -u
    DIR=$1
    OWNER=$2
    GROUP=$3
    cd ${DIR}
    if [[ "${OWNER}" = "donotchange" ]]; then
        chgrp -R ${GROUP} ${DIR}
    else
        chown -R ${OWNER}:${GROUP} ${DIR}
    fi
    chmod -R o-w ${DIR}

    find ${DIR} -type f -exec setfacl -m g:${GROUP}:rw {} \;
    find ${DIR} -type d \
            -exec chmod ug+rwx {} \; \
            -exec setfacl -m g:${GROUP}:rwx {} \; \
            -exec setfacl -d -m g:${GROUP}:rwx {} \;
}

if [ -z "$1" ]; then
    while read -r line; do
        IFS=' ' read -a array <<< "$line"
        updateFacls ${array[0]} ${array[1]} ${array[2]}
    done < /etc/update-facls.conf
else
    processed=0
    while read -r line; do
        if [[ "$line" =~ ^$1.* ]]; then
            IFS=' ' read -a array <<< "$line"
            echo "Processing '${array[0]}' with user '${array[1]}' and group '${array[2]}'"
            updateFacls ${array[0]} ${array[1]} ${array[2]}
            processed=1
        fi
    done < /etc/update-facls.conf
    if [[ "$processed" -eq 0 ]]; then
        echo "Could not read '$1' from /etc/update-facls.conf"
        exit 1
    fi
fi

