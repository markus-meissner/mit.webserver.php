#!/usr/bin/env bash
#
# Managed by ansible (mit.webserver.php)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
#
# Switches php version by moving the pool file and restarting php-fpm.
#
# v2024-03-04-1, markus.meissner@meissner.IT

set -e  # exit on error

usage() {
    echo "Usage: $(basename $0) <pool> <newVersion>"
    echo
    echo "Available versions: ${AVAILABLE_POOLS[@]}"
    echo
    echo "Example: $(basename $0) www.example.com 8.2"
}

readarray -t AVAILABLE_POOLS <<<"$(ls /etc/php/*/fpm/pool.d/www.conf|cut -d/ -f4)"

if [[ $# -ne 2 ]]; then
    usage
else
    POOL=$(basename $1)
    POOL_VERSION=$2
    OLD_POOL=$(find /etc/php/*/fpm/pool.d -name "$POOL.conf")
    if [[ -z $OLD_POOL ]]; then
        echo "Could not find pool $POOL"
        exit 1
    fi
    OLD_VERSION=$(echo $OLD_POOL|cut -d/ -f4)
    NEW_POOL=/etc/php/$POOL_VERSION/fpm/pool.d/$POOL.conf
    if [[ "$OLD_POOL" = "$NEW_POOL" ]]; then
        echo "$POOL is already at version $POOL_VERSION"
    else
        sudo mv -v $OLD_POOL $NEW_POOL
        # Remove pool from old fpm
        sudo php-fpm$OLD_VERSION --test
        sudo service php$OLD_VERSION-fpm restart
        for ver in "${AVAILABLE_POOLS[@]}"; do
            if [[ "$ver" != "$OLD_VERSION" ]]; then
                sudo php-fpm$ver --test
                sudo service php$ver-fpm restart
            fi
        done
        echo "Switched $POOL to php $POOL_VERSION"
    fi
fi

